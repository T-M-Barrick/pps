<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MiTurno - Registro Usuario</title>

    <link rel="stylesheet" href="./registro-usuario.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet" />
      <link rel="icon" type="favicon" href="../../../favicon.ico">
</head>

<body>

    <!-- HEADER -->
    <header>
        <nav>
            <a href="../../../index.html" class="icono-inicio">
                <img src="../../img/home.png" alt="Ir al inicio" />
            </a>
        </nav>

        <figure>
            <img src="../../img/logo-miturno.png" alt="Logo Mi Turno" class="logo" />
        </figure>
    </header>

    <!-- MAIN -->
    <main>
        <form id="formulario-usuario">
            <!-- ========== SECCI√ìN 1 ========== -->
            <section id="seccion-usuario" class="seccion-formulario activa">
                <h2>Datos Personales</h2>

                <!-- Nombre / Apellido -->
                <div class="grid-2">
                    <input type="text" id="nombre" placeholder="Nombre" required class="sombra-input">
                    <input type="text" id="apellido" placeholder="Apellido" required class="sombra-input">
                </div>

                <div class="grid-2">
                    <input type="text" id="dni" placeholder="DNI" class="input-formulario" required />
                    <input type="text" id="telefono" placeholder="Tel√©fono" class="input-formulario" />
                </div>

                <div class="grid-2">
                    <input type="email" id="email" placeholder="Email" class="input-formulario" required />
                    <input type="password" id="clave" placeholder="Password" class="input-formulario" required />
                </div>

                <button type="button" id="btn-siguiente" class="btn-rojo peque√±o">Siguiente</button>
            </section>

            <!-- ========== SECCI√ìN 2 ========== -->
            <section id="seccion-domicilio" class="seccion-formulario">

                <h2>Datos de domicilio</h2>

                <div class="grid-2">
                    <select id="provincia" class="input-formulario" required>
                        <option value="">Seleccione provincia</option>
                    </select>

                    <select id="departamento" class="input-formulario" required>
                        <option value="">Seleccione departamento</option>
                    </select>
                </div>

                <div class="grid-2">
                    <select id="localidad" class="input-formulario" required>
                        <option value="">Seleccione localidad</option>
                    </select>

                    <input type="text" id="calle" placeholder="Calle" class="input-formulario" required>
                </div>

                <div class="grid-2">
                    <input type="text" id="altura" placeholder="Altura" class="input-formulario" required>
                    <input type="text" id="datos_adicionales" placeholder="Datos adicionales" class="input-formulario">
                </div>

                <button type="button" id="btn-buscar" class="btn-rojo peque√±o">Buscar direcci√≥n</button>

                <h3 class="subtitulo">üìç Selecciona la ubicaci√≥n en el mapa:</h3>

                <div id="mapa"></div>

                <p id="texto-coordenadas"></p>

                <!-- Hidden FastAPI -->
                <input type="hidden" id="lat" value="">
                <input type="hidden" id="lng" value="">

                <div class="fila-botones">
                    <button type="button" id="btn-anterior" class="btn-gris">Anterior</button>
                    <button type="submit" class="btn-rojo">Crear Cuenta</button>
                </div>

            </section>

        </form>

        <p id="ya-tienes-cuenta" class="texto-login">
            Ya tienes cuenta,
            <button id="btn-iniciar-sesion" class="btn-borde"
                onclick="window.location.href='../login/login-usuario.html'">
                Iniciar Sesi√≥n
            </button>
        </p>
    </main>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- MAPA: obtiene lat/lng + domicilio -->
    <script type="module">
        import { BACKEND_URL } from "../../../config.js";

        const provSelect = document.getElementById("provincia");
        const deptoSelect = document.getElementById("departamento");
        const locSelect = document.getElementById("localidad");
        const calleInput = document.getElementById("calle");
        const alturaInput = document.getElementById("altura");

        const latInput = document.getElementById("lat");
        const lngInput = document.getElementById("lng");

        // =======================
        // 1) Cargar Provincias
        // =======================
        async function cargarProvincias() {
            const resp = await fetch(`${BACKEND_URL}/georef/provincias`);
            const data = await resp.json();

            provSelect.innerHTML = "<option value=''>Seleccione provincia</option>";
            data.forEach(p => {
                provSelect.innerHTML += `<option value="${p.nombre}">${p.nombre}</option>`;
            });
        }
        cargarProvincias();

        // =======================
        // 2) Cargar Departamentos
        // =======================
        provSelect.onchange = async () => {
            deptoSelect.disabled = true;
            locSelect.disabled = true;

            deptoSelect.innerHTML = "<option>Cargando...</option>";

            const prov = encodeURIComponent(provSelect.value);
            
            const resp = await fetch(`${BACKEND_URL}/georef/departamentos?provincia=${prov}`);
            const data = await resp.json();

            deptoSelect.innerHTML = "<option value=''>Seleccione departamento</option>";

            // Si el backend devolvi√≥ un error, evitar romper la app
            if (!Array.isArray(data)) {
                console.error("Error al cargar departamentos", data);
                deptoSelect.innerHTML = "<option>Error al cargar</option>";
                return;
            }

            data.forEach(d => {
                deptoSelect.innerHTML += `<option value="${d.nombre}">${d.nombre}</option>`;
            });

            deptoSelect.disabled = false;
        };

        // =======================
        // 3) Cargar Localidades
        // =======================
        deptoSelect.onchange = async () => {
            locSelect.disabled = true;
            locSelect.innerHTML = "<option>Cargando...</option>";

            const prov = encodeURIComponent(provSelect.value);
            const depto = encodeURIComponent(deptoSelect.value);

            const resp = await fetch(
                `${BACKEND_URL}/georef/localidades?provincia=${prov}&municipio=${depto}`);
            const data = await resp.json();

            locSelect.innerHTML = "<option value=''>Seleccione localidad</option>";
            data.forEach(l => {
                locSelect.innerHTML += `<option value="${l.nombre}">${l.nombre}</option>`;
            });

            locSelect.disabled = false;
        };

        // =======================
        // 4) Inicializar Mapa
        // =======================
        const map = L.map('mapa').setView([-34.60, -58.38], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);

        let marker = null;

        // 5) Centrar mapa en Localidad

        locSelect.addEventListener("change", async () => {
            const prov = encodeURIComponent(provSelect.value);
            const depto = encodeURIComponent(deptoSelect.value);
            const loc = encodeURIComponent(locSelect.value);

            const resp = await fetch(
                `${BACKEND_URL}/georef/coordenadas?provincia=${prov}&municipio=${depto}&localidad=${loc}`
            );

            const data = await resp.json();

            if (!data || !data.lat || !data.lng) {
                console.error("Coordenadas no encontradas", data);
                return;
            }

            map.setView([data.lat, data.lng], 15);
        });

        // 6) Buscar direcci√≥n
        async function actualizarDesdeTexto() {
            const prov = encodeURIComponent(provSelect.value);
            const depto = encodeURIComponent(deptoSelect.value);
            const loc = encodeURIComponent(locSelect.value);
            const calle = encodeURIComponent(calleInput.value.trim());
            const altura = encodeURIComponent(alturaInput.value.trim());

            if (prov && depto && loc && calle && altura) {

                const resp = await fetch(
                    `${BACKEND_URL}/georef/coordenadas?provincia=${prov}&municipio=${depto}&localidad=${loc}&calle=${calle}&altura=${altura}`
                );
                const data = await resp.json();

                console.log("Resultado de geolocalizaci√≥n:", data);

                if (!data || !data.lat || !data.lng) {
                    console.error("Coordenadas no encontradas", data);
                    return;
                }

                // --- Actualizar mapa ---
                map.setView([data.lat, data.lng], 15);

                if (!marker) {
                    marker = L.marker([data.lat, data.lng]).addTo(map);
                } else {
                    marker.setLatLng([data.lat, data.lng]);
                }

                // Actualizar calle con la calle devuelta
                if (data.calle) {
                    calleInput.value = data.calle;
                }
            }
        }

        calleInput.addEventListener("change", actualizarDesdeTexto);
        alturaInput.addEventListener("change", actualizarDesdeTexto);

        // 7) Click en el mapa ‚Üí SOLO cambia lat/lng
        map.on("click", async e => {
            const lat = e.latlng.lat;
            const lng = e.latlng.lng;

            latInput.value = lat;
            lngInput.value = lng;

            if (!marker) marker = L.marker([lat, lng]).addTo(map);
            else marker.setLatLng([lat, lng]);
        });
    </script>

    <script type="module" defer src="./registro-usuario.js"></script>

</body>

</html>
